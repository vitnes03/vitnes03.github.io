<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Музыкальное радио</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 400px;
            background-color: #242424;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .btn {
            @apply px-6 py-3 rounded-full font-bold transition-all duration-300 transform active:scale-95;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-700 text-white hover:bg-gray-600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .like-btn {
            @apply flex items-center justify-center p-2 rounded-full;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
        .like-btn.liked {
            color: #e0e0e0;
            background-color: #ff4a4a;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-white">Музыкальное Радио</h1>
        
        <div class="flex flex-col items-center gap-4 text-center">
            <div id="cover" class="w-32 h-32 bg-gray-700 rounded-lg animate-pulse shadow-lg"></div>
            <div id="track-info" class="flex flex-col gap-1">
                <div id="title" class="text-lg font-bold">Загрузка...</div>
                <div id="artist" class="text-sm text-gray-400">Пожалуйста, подождите</div>
            </div>
        </div>
        
        <div class="flex items-center justify-center gap-4">
            <button id="like-btn" class="like-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
            </button>
            <audio id="audio-player" class="w-full" controls autoplay></audio>
        </div>
        
        <div id="controls" class="flex flex-col gap-4">
            <input type="text" id="url-input" class="w-full px-4 py-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Вставьте ссылку на YouTube...">
            <button id="add-btn" class="btn btn-primary">Добавить в очередь</button>
            <div class="flex justify-between gap-2">
                <button id="radio-btn" class="btn btn-secondary w-full">Бесконечное Радио</button>
                <button id="stop-btn" class="btn btn-secondary w-full">Остановить Радио</button>
            </div>
            
            <div id="message-box" class="text-center text-sm mt-2"></div>
        </div>
        
        <div class="mt-4">
            <h2 class="text-xl font-bold mb-2">Очередь</h2>
            <ul id="playlist" class="flex flex-col gap-2 bg-gray-800 rounded-lg p-2 max-h-40 overflow-y-auto"></ul>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const audioPlayer = document.getElementById('audio-player');
            const urlInput = document.getElementById('url-input');
            const addBtn = document.getElementById('add-btn');
            const radioBtn = document.getElementById('radio-btn');
            const stopBtn = document.getElementById('stop-btn');
            const playlistElement = document.getElementById('playlist');
            const messageBox = document.getElementById('message-box');
            const titleElement = document.getElementById('title');
            const artistElement = document.getElementById('artist');
            const likeBtn = document.getElementById('like-btn');
            const coverElement = document.getElementById('cover');

            const isRadioMode = window.location.search.includes('mode=radio');
            const BACKEND_URL = 'http://127.0.0.1:5000'; // Замените на URL вашего сервера
            
            let playlist = [];
            let currentTrackIndex = -1;
            let isPlayingRadio = false;

            const updateUI = () => {
                const isRadio = isPlayingRadio || isRadioMode;
                radioBtn.classList.toggle('hidden', isRadio);
                stopBtn.classList.toggle('hidden', !isRadio);
                addBtn.classList.toggle('hidden', isRadio);
                urlInput.classList.toggle('hidden', isRadio);
            };

            const showMessage = (message, isError = false) => {
                messageBox.textContent = message;
                messageBox.style.color = isError ? '#ff6b6b' : '#6b8aff';
                setTimeout(() => messageBox.textContent = '', 3000);
            };

            const playTrack = async (track) => {
                audioPlayer.src = track.url;
                titleElement.textContent = track.title;
                artistElement.textContent = track.artist;
                coverElement.style.backgroundColor = '#3498db'; // Simple placeholder
                coverElement.classList.remove('animate-pulse');
                audioPlayer.play();
                showMessage(`Сейчас играет: ${track.title}`);
                
                // Обновляем список воспроизведения в UI
                if (!isPlayingRadio) {
                    playlistElement.innerHTML = '';
                    playlist.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.textContent = `${item.title} - ${item.artist}`;
                        li.classList.add('p-2', 'rounded-md', 'bg-gray-700', 'truncate');
                        if (index === currentTrackIndex) {
                            li.classList.add('font-bold', 'text-blue-400');
                        }
                        playlistElement.appendChild(li);
                    });
                }
            };

            const fetchAndPlayRadioTrack = async () => {
                try {
                    showMessage('Загрузка следующего трека...', false);
                    const response = await fetch(`${BACKEND_URL}/stream`);
                    if (!response.ok) {
                        throw new Error('Не удалось получить трек с сервера.');
                    }
                    const data = await response.json();
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    await playTrack(data);
                } catch (error) {
                    showMessage(`Ошибка: ${error.message}`, true);
                    isPlayingRadio = false;
                    updateUI();
                }
            };

            const startRadio = () => {
                isPlayingRadio = true;
                updateUI();
                fetchAndPlayRadioTrack();
            };

            const stopRadio = () => {
                isPlayingRadio = false;
                audioPlayer.pause();
                showMessage('Радио остановлено', false);
                updateUI();
            };

            addBtn.addEventListener('click', async () => {
                const url = urlInput.value;
                if (!url) {
                    showMessage('Пожалуйста, вставьте ссылку', true);
                    return;
                }
                
                try {
                    showMessage('Загрузка...', false);
                    const response = await fetch(`${BACKEND_URL}/extract?url=${encodeURIComponent(url)}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    playlist.push(data);
                    currentTrackIndex = playlist.length - 1;
                    playTrack(data);
                    urlInput.value = '';
                } catch (error) {
                    showMessage(`Ошибка: ${error.message}`, true);
                }
            });

            audioPlayer.addEventListener('ended', () => {
                if (isPlayingRadio) {
                    fetchAndPlayRadioTrack();
                } else if (playlist.length > 0 && currentTrackIndex < playlist.length - 1) {
                    currentTrackIndex++;
                    playTrack(playlist[currentTrackIndex]);
                }
            });

            radioBtn.addEventListener('click', startRadio);
            stopBtn.addEventListener('click', stopRadio);

            // Если мини-приложение запущено в режиме "радио" (через /radio)
            if (isRadioMode) {
                startRadio();
            }

            // Добавляем обработчик для кнопки "лайк"
            likeBtn.addEventListener('click', () => {
                likeBtn.classList.toggle('liked');
            });
            
            updateUI(); // Инициализация UI
        });
    </script>
</body>
</html>
