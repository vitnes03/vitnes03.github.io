<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Музыкальные карточки</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
        }
        .player-bar {
            backdrop-filter: blur(10px);
            background-color: rgba(26, 32, 44, 0.7);
        }
    </style>
</head>
<body class="bg-gray-950 flex flex-col items-center min-h-screen p-4">

    <div class="grid grid-cols-2 gap-4 w-full max-w-xl flex-grow pb-24">
        <!-- Левая колонка -->
        <div class="col-span-2 md:col-span-1 flex flex-col gap-4">
            <!-- Карточка "Рекомендации" -->
            <div class="bg-orange-600 rounded-2xl p-6 shadow-xl flex justify-between items-center text-white min-h-[12rem] md:min-h-0">
                <div>
                    <h2 id="recommendations-title" class="text-3xl font-bold">Загрузка...</h2>
                    <p id="recommendations-subtitle" class="text-sm opacity-80 mt-1"></p>
                </div>
                <div class="w-12 h-12 flex items-center justify-center rounded-full bg-white bg-opacity-30">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-white">
                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.715 1.295 2.561 0 3.276l-11.54 6.348C6.029 20.33 4.5 19.426 4.5 18.001V5.653Z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>

            <!-- Карточка "Наши новинки" -->
            <div class="bg-blue-600 rounded-2xl p-6 shadow-xl flex justify-between items-center text-white min-h-[12rem] md:min-h-0">
                <div>
                    <h2 id="new-releases-title" class="text-3xl font-bold">Загрузка...</h2>
                    <p id="new-releases-subtitle" class="text-sm opacity-80 mt-1"></p>
                </div>
                <div class="w-12 h-12 flex items-center justify-center rounded-full bg-white bg-opacity-30">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-white">
                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.715 1.295 2.561 0 3.276l-11.54 6.348C6.029 20.33 4.5 19.426 4.5 18.001V5.653Z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Правая колонка -->
        <div class="col-span-2 md:col-span-1">
            <!-- Карточка "Мой плейлист дня" -->
            <div class="bg-pink-600 rounded-2xl p-6 shadow-xl flex justify-between items-center text-white w-full h-full min-h-[12rem] md:min-h-0">
                <div>
                    <h2 id="my-playlist-title" class="text-3xl font-bold">Загрузка...</h2>
                    <p id="my-playlist-subtitle" class="text-sm opacity-80 mt-1"></p>
                </div>
                <div class="self-center mt-auto">
                    <div class="w-12 h-12 flex items-center justify-center rounded-full bg-white bg-opacity-30">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-white">
                            <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.715 1.295 2.561 0 3.276l-11.54 6.348C6.029 20.33 4.5 19.426 4.5 18.001V5.653Z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Music Player Bar -->
    <div id="player-bar" class="player-bar fixed bottom-0 w-full max-w-xl p-4 flex flex-col space-y-2 rounded-t-2xl shadow-lg">
        <div class="flex items-center space-x-4">
            <div class="w-16 h-16 bg-gray-700 rounded-lg flex-shrink-0">
                <img id="current-song-art" src="https://placehold.co/64x64/262626/808080?text=♫" alt="Album Art" class="rounded-lg w-full h-full object-cover">
            </div>
            <div class="flex-grow min-w-0">
                <div id="current-song-title" class="text-lg font-semibold truncate">Нет песни</div>
                <div id="current-song-artist" class="text-sm text-gray-400 truncate"></div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="prev-btn" class="p-2 rounded-full text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M10.72 2.25a.75.75 0 0 0-1.06 0l-7.5 7.5a.75.75 0 0 0 0 1.06l7.5 7.5a.75.75 0 0 0 1.06-1.06L5.81 12h14.44a.75.75 0 0 0 0-1.5H5.81l4.91-4.97a.75.75 0 0 0 0-1.06Z" clip-rule="evenodd" /></svg>
                </button>
                <button id="play-pause-btn" class="w-12 h-12 flex items-center justify-center rounded-full bg-blue-600 hover:bg-blue-700 transition-colors text-white">
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.715 1.295 2.561 0 3.276l-11.54 6.348C6.029 20.33 4.5 19.426 4.5 18.001V5.653Z" clip-rule="evenodd" />
                    </svg>
                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 hidden">
                        <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25Zm7.5 0A.75.75 0 0 1 15 4.5h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H15a.75.75 0 0 1-.75-.75V5.25Z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button id="next-btn" class="p-2 rounded-full text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M13.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L11.69 12 4.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M19.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 1 1-1.06-1.06L17.69 12l-5.47-5.47a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </div>
        <div class="flex items-center space-x-2">
            <span id="current-time" class="text-xs text-gray-400">0:00</span>
            <div id="progress-bar-container" class="flex-grow h-1 bg-gray-600 rounded-full cursor-pointer">
                <div id="progress-bar" class="h-1 bg-blue-500 rounded-full" style="width: 0%;"></div>
            </div>
            <span id="duration" class="text-xs text-gray-400">0:00</span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const recommendationsTitle = document.getElementById('recommendations-title');
            const recommendationsSubtitle = document.getElementById('recommendations-subtitle');
            const newReleasesTitle = document.getElementById('new-releases-title');
            const newReleasesSubtitle = document.getElementById('new-releases-subtitle');
            const myPlaylistTitle = document.getElementById('my-playlist-title');
            const myPlaylistSubtitle = document.getElementById('my-playlist-subtitle');

            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const currentSongTitle = document.getElementById('current-song-title');
            const currentSongArtist = document.getElementById('current-song-artist');
            const currentSongArt = document.getElementById('current-song-art');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            const progressBar = document.getElementById('progress-bar');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            let audio = new Audio();
            let currentTrackIndex = -1;
            let songs = [];

            const fetchCardData = async () => {
                try {
                    const response = await fetch('http://127.0.0.1:5000/api/cards');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    recommendationsTitle.textContent = data.recommendations.title;
                    recommendationsSubtitle.textContent = data.recommendations.subtitle;
                    newReleasesTitle.textContent = data.new_releases.title;
                    newReleasesSubtitle.textContent = data.new_releases.subtitle;
                    myPlaylistTitle.textContent = data.my_playlist.title;
                    myPlaylistSubtitle.textContent = data.my_playlist.subtitle;

                } catch (error) {
                    console.error('Ошибка при получении данных:', error);
                    recommendationsTitle.textContent = 'Ошибка';
                    newReleasesTitle.textContent = 'Ошибка';
                    myPlaylistTitle.textContent = 'Ошибка';
                }
            };
            
            const fetchPlaylistData = async () => {
                try {
                    const response = await fetch('http://127.0.0.1:5000/api/playlist');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    songs = await response.json();
                    if (songs.length > 0) {
                        playTrack(0);
                        audio.pause();
                        playIcon.classList.remove('hidden');
                        pauseIcon.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Ошибка при получении плейлиста:', error);
                }
            };

            const playTrack = (index) => {
                if (index < 0 || index >= songs.length) return;
                currentTrackIndex = index;
                const track = songs[currentTrackIndex];
                
                audio.src = track.url;
                audio.play();
                
                currentSongTitle.textContent = track.title;
                currentSongArtist.textContent = track.artist;
                currentSongArt.src = track.image;
                
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            };

            const togglePlayPause = () => {
                if (audio.paused) {
                    audio.play();
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                } else {
                    audio.pause();
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                }
            };

            const formatTime = (seconds) => {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
            };

            // Event Listeners for player controls
            playPauseBtn.addEventListener('click', () => {
                if (currentTrackIndex === -1) {
                    playTrack(0);
                } else {
                    togglePlayPause();
                }
            });

            nextBtn.addEventListener('click', () => {
                const nextIndex = (currentTrackIndex + 1) % songs.length;
                playTrack(nextIndex);
            });

            prevBtn.addEventListener('click', () => {
                const prevIndex = (currentTrackIndex - 1 + songs.length) % songs.length;
                playTrack(prevIndex);
            });

            // Update progress bar
            audio.addEventListener('timeupdate', () => {
                const progress = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = `${progress}%`;
                currentTimeEl.textContent = formatTime(audio.currentTime);
            });
            
            audio.addEventListener('loadedmetadata', () => {
                durationEl.textContent = formatTime(audio.duration);
            });

            // Seek functionality
            progressBarContainer.addEventListener('click', (e) => {
                const clickX = e.offsetX;
                const containerWidth = progressBarContainer.offsetWidth;
                const seekTime = (clickX / containerWidth) * audio.duration;
                audio.currentTime = seekTime;
            });
            
            fetchCardData();
            fetchPlaylistData();
        });
    </script>
</body>
</html>
